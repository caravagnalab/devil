set -x
set -e

# Parse command line arguments for CUDA support
USE_CUDA=0
for arg in "$@"; do
  case $arg in
    --with-cuda)
      USE_CUDA=1
      shift
      ;;
    --without-cuda)
      USE_CUDA=0
      shift
      ;;
  esac
done

which cmake

# Check if cuda directory exists
if [ ! -d cuda ]; then
    echo "ERROR: cuda directory not found!"
    echo "The cuda directory should be included in the package source."
    exit 1
fi

${R_HOME}/bin/R --vanilla --silent -e 'Rcpp::compileAttributes()'

# Write USE_CUDA to a file that Makevars can include
echo "Configuring with CUDA support: $USE_CUDA"
echo "USE_CUDA=$USE_CUDA" > src/Makevars.config

# If CUDA is disabled, remove the Rcpp::export annotation from beta_fit_gpu
# to prevent Rcpp from generating exports for unavailable functions
if [ "$USE_CUDA" -eq 0 ]; then
    echo "Removing beta_fit_gpu export (CUDA disabled)"
    # Create backup
    cp src/beta.cpp src/beta.cpp.bak
    # Remove the // [[Rcpp::export]] line immediately before beta_fit_gpu
    if sed --version >/dev/null 2>&1; then
        # GNU sed
        sed -i '/^#ifdef USE_CUDA$/{
            n
            /^\/\/ \[\[Rcpp::export\]\]$/d
        }' src/beta.cpp
    else
        # BSD sed (macOS)
        sed -i '' '/^#ifdef USE_CUDA$/{
            n
            /^\/\/ \[\[Rcpp::export\]\]$/d
        }' src/beta.cpp
    fi

    # Regenerate Rcpp exports without beta_fit_gpu
    ${R_HOME}/bin/R --vanilla --silent -e 'Rcpp::compileAttributes()'
    # Restore original file for version control
    mv src/beta.cpp.bak src/beta.cpp
else
    echo "CUDA support enabled - beta_fit_gpu will be available"
fi

